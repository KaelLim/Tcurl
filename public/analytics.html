<!DOCTYPE html>
<html class="dark" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>數據分析 - TCurl</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1337ec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101322",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark">
    <div class="flex min-h-screen">
        <!-- SideNavBar -->
        <aside class="w-64 flex-shrink-0 bg-[#111218] p-4 flex flex-col justify-between border-r border-r-[#3b3f54]">
            <div class="flex flex-col gap-8">
                <div class="flex items-center gap-2 p-2">
                    <img src="/images/logo.png" alt="TCurl Logo" style="width: 76px; height: 40px;">
                    <div>
                        <h1 class="text-white text-xl font-bold">TCurl</h1>
                        <p class="text-white/60 text-xs">慈濟短網址</p>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-white hover:bg-[#282b39]" href="/">
                        <span class="material-symbols-outlined text-white">home</span>
                        <p class="text-sm font-medium leading-normal">首頁</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg text-white hover:bg-[#282b39]" href="/links">
                        <span class="material-symbols-outlined text-white">link</span>
                        <p class="text-sm font-medium leading-normal">我的連結</p>
                    </a>
                    <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-[#282b39] text-white" href="/analytics">
                        <span class="material-symbols-outlined text-white">bar_chart</span>
                        <p class="text-sm font-medium leading-normal">數據分析</p>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex flex-1 justify-center py-8">
            <div class="flex w-full max-w-7xl flex-col gap-8 px-4 sm:px-6 lg:px-8">
                <!-- PageHeading -->
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-col gap-2">
                        <p class="text-white text-3xl md:text-4xl font-bold leading-tight tracking-[-0.033em]">數據分析總覽</p>
                        <p class="text-white/60 text-sm font-normal leading-normal">查看所有短網址的使用統計</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
                    <div class="flex flex-col gap-2 rounded-xl border border-white/10 bg-white/5 p-5">
                        <p class="text-white/80 text-base font-medium leading-normal">總連結數</p>
                        <p id="totalUrls" class="text-white tracking-light text-3xl font-bold leading-tight">-</p>
                        <p class="text-white/60 text-base font-medium leading-normal">已建立的短網址</p>
                    </div>
                    <div class="flex flex-col gap-2 rounded-xl border border-white/10 bg-white/5 p-5">
                        <p class="text-white/80 text-base font-medium leading-normal">總點擊數</p>
                        <p id="totalClicks" class="text-white tracking-light text-3xl font-bold leading-tight">-</p>
                        <p class="text-white/60 text-base font-medium leading-normal">所有連結的點擊</p>
                    </div>
                    <div class="flex flex-col gap-2 rounded-xl border border-white/10 bg-white/5 p-5">
                        <p class="text-white/80 text-base font-medium leading-normal">平均點擊數</p>
                        <p id="avgClicks" class="text-white tracking-light text-3xl font-bold leading-tight">-</p>
                        <p class="text-white/60 text-base font-medium leading-normal">每個連結平均</p>
                    </div>
                    <div class="flex flex-col gap-2 rounded-xl border border-white/10 bg-white/5 p-5">
                        <p class="text-white/80 text-base font-medium leading-normal">QR 掃描數</p>
                        <p id="totalQrScans" class="text-white tracking-light text-3xl font-bold leading-tight">-</p>
                        <p class="text-white/60 text-base font-medium leading-normal">透過 QR Code 訪問</p>
                    </div>
                </div>

                <!-- Daily Trend Chart -->
                <div class="flex flex-col gap-4 rounded-xl border border-white/10 bg-white/5 p-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-white text-lg font-medium leading-normal">每日趨勢</h3>
                        <select id="chartPeriod" class="bg-white/10 text-white text-sm rounded-lg px-3 py-1.5 border border-white/20 focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="7">最近 7 天</option>
                            <option value="30" selected>最近 30 天</option>
                            <option value="90">最近 90 天</option>
                        </select>
                    </div>
                    <div class="w-full" style="height: 300px;">
                        <canvas id="dailyTrendChart"></canvas>
                    </div>
                </div>

                <!-- Top URLs Table -->
                <div class="flex flex-col gap-4 rounded-xl border border-white/10 bg-white/5 p-6">
                    <h3 class="text-white text-lg font-medium leading-normal">熱門連結 Top 10</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-white/10">
                                    <th class="text-left text-white/80 text-sm font-medium p-3">排名</th>
                                    <th class="text-left text-white/80 text-sm font-medium p-3">短代碼</th>
                                    <th class="text-left text-white/80 text-sm font-medium p-3">原始網址</th>
                                    <th class="text-left text-white/80 text-sm font-medium p-3">點擊數</th>
                                    <th class="text-left text-white/80 text-sm font-medium p-3">佔比</th>
                                </tr>
                            </thead>
                            <tbody id="topUrlsBody">
                                <tr>
                                    <td colspan="5" class="text-center p-8 text-white/60">載入中...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Include API and Analytics JS -->
    <script src="/js/api.js"></script>
    <script>
        // Analytics JavaScript (內嵌，因為較簡單)
        let allUrls = []
        let dailyChart = null

        async function loadAnalytics() {
            try {
                const response = await api.getUrls()
                allUrls = Array.isArray(response) ? response : (response.data || [])

                updateStats()
                renderTopUrls()
                await loadDailyTrend(30)
            } catch (error) {
                console.error('Error loading analytics:', error)
                utils.showNotification('載入數據失敗', 'error')
            }
        }

        async function loadDailyTrend(days) {
            try {
                const response = await fetch(`${window.location.origin}/api/stats/daily?days=${days}`)
                if (!response.ok) {
                    throw new Error('Failed to fetch daily stats')
                }
                const dailyData = await response.json()
                renderDailyChart(dailyData)
            } catch (error) {
                console.error('Error loading daily trend:', error)
            }
        }

        function renderDailyChart(data) {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d')

            // 準備數據
            const labels = data.map(d => {
                const date = new Date(d.date)
                return `${date.getMonth() + 1}/${date.getDate()}`
            })
            const linkClicks = data.map(d => d.link_clicks || 0)
            const qrScans = data.map(d => d.qr_scans || 0)

            // 如果已有圖表，先銷毀
            if (dailyChart) {
                dailyChart.destroy()
            }

            // 創建新圖表
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '連結點擊',
                            data: linkClicks,
                            borderColor: '#1337ec',
                            backgroundColor: 'rgba(19, 55, 236, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'QR 掃描',
                            data: qrScans,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                                font: {
                                    family: 'Space Grotesk',
                                    size: 12
                                },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(17, 18, 24, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                family: 'Space Grotesk',
                                size: 14
                            },
                            bodyFont: {
                                family: 'Space Grotesk',
                                size: 13
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9da1b9',
                                font: {
                                    family: 'Space Grotesk',
                                    size: 11
                                },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#9da1b9',
                                font: {
                                    family: 'Space Grotesk',
                                    size: 11
                                },
                                precision: 0
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            })
        }

        function updateStats() {
            // 總連結數
            document.getElementById('totalUrls').textContent = allUrls.length

            // 總點擊數
            const totalClicks = allUrls.reduce((sum, url) => sum + (url.clicks || 0), 0)
            document.getElementById('totalClicks').textContent = totalClicks.toLocaleString()

            // 平均點擊數
            const avgClicks = allUrls.length > 0 ? Math.round(totalClicks / allUrls.length) : 0
            document.getElementById('avgClicks').textContent = avgClicks.toLocaleString()

            // QR 掃描數
            const totalQrScans = allUrls.reduce((sum, url) => sum + (url.qr_scans || 0), 0)
            document.getElementById('totalQrScans').textContent = totalQrScans.toLocaleString()
        }

        function renderTopUrls() {
            const topUrls = [...allUrls]
                .sort((a, b) => (b.clicks || 0) - (a.clicks || 0))
                .slice(0, 10)

            const totalClicks = allUrls.reduce((sum, url) => sum + (url.clicks || 0), 0)
            const tbody = document.getElementById('topUrlsBody')

            if (topUrls.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-white/60">尚無數據</td></tr>'
                return
            }

            tbody.innerHTML = topUrls.map((url, index) => {
                const percentage = totalClicks > 0 ? ((url.clicks || 0) / totalClicks * 100).toFixed(1) : 0
                const shortUrl = `${window.location.origin}/s/${url.short_code}`
                const displayUrl = url.original_url.length > 50
                    ? url.original_url.substring(0, 50) + '...'
                    : url.original_url

                return `
                    <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-3">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${
                                index < 3 ? 'bg-primary/20 text-primary' : 'bg-white/10 text-white/60'
                            } font-bold text-sm">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="p-3">
                            <a href="${shortUrl}" target="_blank" class="text-primary hover:underline font-medium">
                                ${url.short_code}
                            </a>
                        </td>
                        <td class="p-3">
                            <span class="text-white/80 text-sm" title="${url.original_url}">
                                ${displayUrl}
                            </span>
                        </td>
                        <td class="p-3">
                            <span class="text-white font-bold">${(url.clicks || 0).toLocaleString()}</span>
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <div class="flex-1 h-2 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-primary rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-white/60 text-sm w-12 text-right">${percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `
            }).join('')
        }

        // 時間段選擇器事件監聽
        document.getElementById('chartPeriod').addEventListener('change', async (e) => {
            const days = parseInt(e.target.value)
            await loadDailyTrend(days)
        })

        // 初始載入
        loadAnalytics()
    </script>
    <script>
            }
        })
    </script>
</body>
</html>
