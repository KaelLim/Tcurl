# è³‡å®‰å¾…è¾¦äº‹é …æ¸…å–®

æœ¬æ–‡ä»¶è¿½è¹¤ TCurl çŸ­ç¶²å€ç³»çµ±çš„è³‡å®‰å¯¦æ–½é€²åº¦ï¼ŒåŸºæ–¼ ISO 27001/27034 æ¡†æ¶èˆ‡ OWASP æ¨™æº–ã€‚

**å¯©æŸ¥æ—¥æœŸ**: 2025-12-05
**å¯©æŸ¥çµæœ**: é«˜å„ªå…ˆç´šå•é¡Œå·²å…¨éƒ¨ä¿®å¾©ï¼Œä¸­å„ªå…ˆç´šå•é¡Œå¾…è™•ç†

---

## ğŸ”´ é«˜å„ªå…ˆç´šå•é¡Œï¼ˆå¿…é ˆç«‹å³ä¿®å¾©ï¼‰

### 1. âœ… CORS è¨­å®šéæ–¼å¯¬é¬†ï¼ˆå·²ä¿®å¾©ï¼‰
**æª”æ¡ˆ**: `src/index.ts:50-75`
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©å…§å®¹**:
- æ”¹ç‚ºç™½åå–®æ¨¡å¼ï¼Œåªå…è¨± `https://url.tzuchi.org`
- é–‹ç™¼ç’°å¢ƒè‡ªå‹•å…è¨± `localhost:3000` å’Œ `localhost:8080`
- æ”¯æ´é€é `CORS_ORIGIN` ç’°å¢ƒè®Šæ•¸æ–°å¢é¡å¤–ä¾†æº
- è¨˜éŒ„è¢«æ‹’çµ•çš„ä¾†æºï¼ˆæ–¹ä¾¿é™¤éŒ¯ï¼‰
- [x] **å·²å®Œæˆ**

### 2. âœ… npm å¥—ä»¶æ¼æ´ï¼ˆå·²ä¿®å¾©ï¼‰
**å¥—ä»¶**: `glob@11.0.0-11.0.3` â†’ `glob@11.1.0`
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©æ–¹å¼**: `npm audit fix`
**é©—è­‰çµæœ**: `npm audit` é¡¯ç¤º 0 vulnerabilities
- [x] **å·²å®Œæˆ**

### 3. âœ… ç¼ºå°‘å®‰å…¨ Headersï¼ˆå·²ä¿®å¾©ï¼‰
**æª”æ¡ˆ**: `src/index.ts:30-87`
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©å…§å®¹**: å®‰è£ä¸¦è¨­å®š @fastify/helmetï¼ŒåŒ…å«ä»¥ä¸‹å®‰å…¨ Headersï¼š

| Header | è¨­å®šå€¼ | é˜²è­· |
|--------|--------|------|
| Content-Security-Policy | å®Œæ•´ CSP | XSSã€è³‡æ–™æ³¨å…¥ |
| X-Frame-Options | DENY | Clickjacking |
| X-Content-Type-Options | nosniff | MIME sniffing |
| Strict-Transport-Security | max-age=31536000 | å¼·åˆ¶ HTTPS |
| Referrer-Policy | strict-origin-when-cross-origin | éš±ç§ä¿è­· |
| X-XSS-Protection | 1; mode=block | XSS éæ¿¾ |

- [x] **å·²å®Œæˆ**

### 4. âœ… ç¼ºå°‘ URL æ ¼å¼é©—è­‰ï¼ˆå·²ä¿®å¾©ï¼‰
**æª”æ¡ˆ**: `src/utils/url-validator.ts`ï¼ˆæ–°å»ºï¼‰ã€`src/routes/urls.ts:52-58, 299-308`
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©å…§å®¹**:
- å»ºç«‹ `validateUrl()` å‡½æ•¸ï¼Œå®Œæ•´é©—è­‰ URL å®‰å…¨æ€§
- åœ¨å»ºç«‹çŸ­ç¶²å€ APIï¼ˆPOST /api/urlsï¼‰åŠ å…¥é©—è­‰
- åœ¨æ›´æ–°çŸ­ç¶²å€ APIï¼ˆPUT /api/urls/:idï¼‰åŠ å…¥é©—è­‰

**é˜»æ“‹çš„æ”»æ“Šå‘é‡**:
| é¡å‹ | ç¯„ä¾‹ | é˜²è­· |
|------|------|------|
| ç§æœ‰ IP | 127.0.0.1, 10.x.x.x, 192.168.x.x | âœ… é˜»æ“‹ |
| é›²ç«¯ Metadata | 169.254.169.254 | âœ… é˜»æ“‹ |
| é HTTP å”è­° | file://, gopher://, ftp:// | âœ… é˜»æ“‹ |
| å±éšªç«¯å£ | :6379 (Redis), :5432 (PostgreSQL) | âœ… é˜»æ“‹ |

- [x] **å·²å®Œæˆ**

### 5. âœ… .env æª”æ¡ˆæ¬Šé™éæ–¼å¯¬é¬†ï¼ˆå·²ä¿®å¾©ï¼‰
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©å‰**: `rwxrwxr-x` (775)
**ä¿®å¾©å¾Œ**: `rw-------` (600)
**ä¿®å¾©æ–¹å¼**: `chmod 600 .env`
- [x] **å·²å®Œæˆ**

### 6. âœ… ç¼ºå°‘ .gitignore æª”æ¡ˆï¼ˆå·²ä¿®å¾©ï¼‰
**ä¿®å¾©æ—¥æœŸ**: 2024-12-05
**ä¿®å¾©å…§å®¹**: å»ºç«‹ `.gitignore` åŒ…å«ï¼š
- ç’°å¢ƒè®Šæ•¸æª”æ¡ˆï¼ˆ.env, .env.local ç­‰ï¼‰
- node_modules/
- dist/
- logs/ å’Œ *.log
- public/qrcodes/*.png
- ç·¨è¼¯å™¨è¨­å®šï¼ˆ.vscode/, .idea/ï¼‰
- å‚™ä»½æª”æ¡ˆï¼ˆbackups/*.sqlï¼‰
- [x] **å·²å®Œæˆ**

---

## ğŸŸ¡ ä¸­å„ªå…ˆç´šå•é¡Œ

### 7. âœ… å‰ç«¯çŸ­ä»£ç¢¼ç”Ÿæˆä½¿ç”¨ä¸å®‰å…¨çš„éš¨æ©Ÿå‡½æ•¸ï¼ˆå·²ä¿®å¾©ï¼‰
**æª”æ¡ˆ**: `public/js/api.js:7-11`
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**åŸå•é¡Œ**: ä½¿ç”¨ `Math.random()` ç”ŸæˆçŸ­ä»£ç¢¼
**ä¿®å¾©å…§å®¹**: æ”¹ç”¨ `crypto.getRandomValues()` å¯†ç¢¼å­¸å®‰å…¨éš¨æ©Ÿæ•¸
```javascript
function generateShortCode(length = 6) {
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
  const array = new Uint32Array(length)
  crypto.getRandomValues(array)
  return Array.from(array, x => chars[x % chars.length]).join('')
}
```
- [x] **å·²å®Œæˆ**

### 8. â­ï¸ å¯†ç¢¼è¤‡é›œåº¦é©—è­‰ï¼ˆå·²ç•¥éï¼‰
**åŸå› **: è¨ˆç•«å°å…¥ OAuthï¼Œæ­¤é …ç›®ä¸å†éœ€è¦
**ç‹€æ…‹**: ç•¥é

### 9. âœ… Redis å®‰å…¨è¨­å®šï¼ˆå·²ç¢ºèªå®‰å…¨ï¼‰
**æª”æ¡ˆ**: `src/services/redis.ts`
**ç¢ºèªæ—¥æœŸ**: 2025-12-05
**ç¾ç‹€æª¢æŸ¥**:
| è¨­å®š | å€¼ | å®‰å…¨æ€§ |
|------|------|--------|
| Docker ç«¯å£ç¶å®š | `127.0.0.1:6379` | âœ… åªæœ‰æœ¬æ©Ÿå¯å­˜å– |
| å¯†ç¢¼ | ç„¡ï¼ˆå¯é¸é…ç½®ï¼‰| âš ï¸ å›  Docker é™åˆ¶ï¼Œé¢¨éšªä½ |

**å·²åŠ å…¥åŠŸèƒ½**: æ”¯æ´ `REDIS_PASSWORD` ç’°å¢ƒè®Šæ•¸ï¼ˆå¯é¸ï¼‰
```typescript
export const redis = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: Number(process.env.REDIS_PORT) || 6379,
  password: process.env.REDIS_PASSWORD || undefined,  // æ”¯æ´å¯†ç¢¼èªè­‰
  // ...
})
```
- [x] **å·²å®Œæˆ**ï¼ˆDocker å·²é™åˆ¶ç‚º localhostï¼Œç¨‹å¼ç¢¼å·²æ”¯æ´å¯†ç¢¼ï¼‰

### 10. â­ï¸ å¸³è™Ÿé–å®šæ©Ÿåˆ¶ï¼ˆå·²ç•¥éï¼‰
**åŸå› **: è¨ˆç•«å°å…¥ OAuthï¼Œç”± OAuth æä¾›è€…è™•ç†å¸³è™Ÿå®‰å…¨
**å‚™è¨»**: å¯†ç¢¼ä¿è­·çŸ­ç¶²å€å·²æœ‰ Rate Limitingï¼ˆ5 æ¬¡/åˆ†é˜ï¼‰
**ç‹€æ…‹**: ç•¥é

### 11. âœ… SRI å®Œæ•´æ€§æª¢æŸ¥ï¼ˆå·²å®Œæˆï¼‰
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**èªªæ˜**: ç‚º CDN è³‡æºåŠ å…¥ Subresource Integrity (SRI) é©—è­‰ï¼Œé˜²æ­¢ CDN è¢«å…¥ä¾µæ™‚è¼‰å…¥æƒ¡æ„ç¨‹å¼ç¢¼

**å·²åŠ å…¥ SRI çš„è³‡æº**:
| CDN è³‡æº | ç‰ˆæœ¬ | æª”æ¡ˆ |
|----------|------|------|
| QR Code Styling | 1.5.0 | index.html, edit.html, links.html, analytics.html |
| Chart.js | 4.4.1 | analytics.html |

**ç„¡æ³•ä½¿ç”¨ SRI çš„è³‡æº**ï¼ˆå‹•æ…‹ç”Ÿæˆï¼‰:
- Tailwind CSS (`cdn.tailwindcss.com`) - æ ¹æ“šé…ç½®å‹•æ…‹ç”Ÿæˆ
- Google Fonts - æ ¹æ“šç€è¦½å™¨å‹•æ…‹ç”Ÿæˆ

**SRI Hash å€¼**:
```
QR Code Styling 1.5.0:
sha384-CHvehSuS0IW8Qj9IlAETJXbHf/SEi62VXMgODXi9p3CC3NUIuThj1Y0uAFnl30VB

Chart.js 4.4.1:
sha384-9nhczxUqK87bcKHh20fSQcTGD4qq5GhayNYSYWqwBkINBhOfQLg/P5HG5lF1urn4
```

- [x] **å·²å®Œæˆ**

---

## ğŸ”µ ç¬¬äºŒéšæ®µç™¼ç¾çš„å•é¡Œï¼ˆæ·±åº¦åˆ†æï¼‰

**åˆ†ææ—¥æœŸ**: 2025-12-05
**åˆ†ææ–¹æ³•**: å®Œæ•´ç¨‹å¼ç¢¼å¯©æŸ¥ + OWASP Top 10 æª¢æŸ¥

### 12. âœ… Promise Rejection æœªè™•ç†ï¼ˆå·²ä¿®å¾©ï¼‰
**é¢¨éšªç­‰ç´š**: ğŸŸ  ä¸­
**æª”æ¡ˆ**: `src/routes/urls.ts` è¡Œè™Ÿ 721-729, 767-776, 817-825, 857-865
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**ä¿®å¾©å…§å®¹**: ä½¿ç”¨ `Promise.resolve()` åŒ…è£ä¸¦åŠ å…¥ `.catch()` éŒ¯èª¤è™•ç†
```typescript
Promise.resolve(
  supabase.from('url_clicks').insert({...})
).catch((err: Error) => {
  fastify.log.error({ err, url_id }, 'Failed to record click')
})
```
**ä¿®å¾©ä½ç½®**:
- å¯†ç¢¼é©—è­‰å¾Œè¨˜éŒ„é»æ“Š
- å¿«å–å‘½ä¸­æ™‚è¨˜éŒ„é»æ“Š
- å¿«å–æœªå‘½ä¸­æ™‚è¨˜éŒ„é»æ“Š
- Redis å¤±æ•—å›é€€æ™‚è¨˜éŒ„é»æ“Š
- [x] **å·²å®Œæˆ**

### 13. CSP åŒ…å« unsafe-inline å’Œ unsafe-eval
**é¢¨éšªç­‰ç´š**: ğŸŸ  ä¸­
**æª”æ¡ˆ**: `src/index.ts` è¡Œè™Ÿ 36-46
**å•é¡Œ**: CSP è¨­å®šå…è¨± inline script å’Œ evalï¼Œé™ä½ XSS é˜²è­·æ•ˆæœ
**åŸå› **: Tailwind CDN å’ŒæŸäº› library éœ€è¦é€™äº›åŠŸèƒ½
**å»ºè­°**:
- çŸ­æœŸï¼šç¶­æŒç¾ç‹€ï¼ˆå·²æœ‰å…¶ä»– XSS é˜²è­·ï¼‰
- é•·æœŸï¼šæ”¹ç”¨æœ¬åœ°ç·¨è­¯çš„ Tailwind CSSï¼Œç§»é™¤ unsafe-inline
- [ ] **å¯é¸æ”¹é€²**

### 14. âœ… çŸ­ä»£ç¢¼ç”Ÿæˆå­˜åœ¨ç«¶çˆ­æ¢ä»¶ï¼ˆå·²ä¿®å¾©ï¼‰
**é¢¨éšªç­‰ç´š**: ğŸŸ  ä¸­
**æª”æ¡ˆ**: `src/routes/urls.ts` è¡Œè™Ÿ 73-120
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**ä¿®å¾©å…§å®¹**: æ”¹ç”¨ã€Œç›´æ¥æ’å…¥ + é‡è©¦ã€æ¨¡å¼ï¼Œä¾è³´è³‡æ–™åº« UNIQUE ç´„æŸ
**ä¿®å¾©é‚è¼¯**:
```typescript
while (attempts < maxAttempts) {
  const currentShortCode = short_code || generateShortCode(6)
  const { data, error } = await userClient.from('urls').insert({...})

  if (!error) break  // æˆåŠŸ

  if (error.code === '23505') {  // UNIQUE é•å
    if (short_code) return 409   // è‡ªè¨‚çŸ­ä»£ç¢¼å·²å­˜åœ¨
    attempts++                    // è‡ªå‹•ç”Ÿæˆçš„ï¼Œé‡è©¦
    continue
  }

  throw error  // å…¶ä»–éŒ¯èª¤
}
```
**å„ªé»**:
- æ¶ˆé™¤ç«¶çˆ­æ¢ä»¶æ™‚é–“çª—å£
- è‡ªè¨‚çŸ­ä»£ç¢¼ä»æœƒæª¢æŸ¥é‡è¤‡
- è‡ªå‹•ç”Ÿæˆçš„çŸ­ä»£ç¢¼è¡çªæ™‚è‡ªå‹•é‡è©¦
- [x] **å·²å®Œæˆ**

### 15. âœ… QR Code ä¸Šå‚³ç¼ºå°‘å®Œæ•´é©—è­‰ï¼ˆå·²ä¿®å¾©ï¼‰
**é¢¨éšªç­‰ç´š**: ğŸŸ¡ ä½
**æª”æ¡ˆ**: `src/routes/urls.ts` è¡Œè™Ÿ 394-410
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**ä¿®å¾©å…§å®¹**:
1. **æª”æ¡ˆå¤§å°é™åˆ¶**: æœ€å¤§ 1MB
2. **PNG æ ¼å¼é©—è­‰**: æª¢æŸ¥ PNG æª”é ­ç°½åï¼ˆ8 bytesï¼‰
```typescript
// é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆæœ€å¤§ 1MBï¼‰
const maxSize = 1 * 1024 * 1024
if (buffer.length > maxSize) {
  return reply.code(400).send({ error: 'QR Code æª”æ¡ˆéå¤§' })
}

// é©—è­‰ PNG æ ¼å¼
const pngSignature = Buffer.from([137, 80, 78, 71, 13, 10, 26, 10])
if (!buffer.subarray(0, 8).equals(pngSignature)) {
  return reply.code(400).send({ error: 'ç„¡æ•ˆçš„ PNG æª”æ¡ˆæ ¼å¼' })
}
```
- [x] **å·²å®Œæˆ**

### 16. âœ… ç¼ºå°‘ Timing Attack é˜²è­·ï¼ˆå·²ä¿®å¾©ï¼‰
**é¢¨éšªç­‰ç´š**: ğŸŸ¡ ä½
**æª”æ¡ˆ**: `src/routes/urls.ts` è¡Œè™Ÿ 732-745
**ä¿®å¾©æ—¥æœŸ**: 2025-12-05
**ä¿®å¾©å…§å®¹**: ç¢ºä¿å¯†ç¢¼é©—è­‰å›æ‡‰æ™‚é–“å›ºå®šç‚ºè‡³å°‘ 500ms
```typescript
const startTime = Date.now()
const isValid = await bcrypt.compare(password, data.password_hash)
const elapsed = Date.now() - startTime

const minDelay = 500
if (elapsed < minDelay) {
  await new Promise(resolve => setTimeout(resolve, minDelay - elapsed))
}
```
- [x] **å·²å®Œæˆ**

---

## ğŸ“‹ ISO 27001/27034 é¡å¤–æª¢æŸ¥é …ç›®

### ISO 27001 æ§åˆ¶é …å°ç…§

| æ§åˆ¶é … | èªªæ˜ | ç‹€æ…‹ | å‚™è¨» |
|--------|------|------|------|
| A.9.4.2 | å®‰å…¨ç™»å…¥ç¨‹åº | âœ… | Supabase Auth + Rate Limiting |
| A.9.4.3 | å¯†ç¢¼ç®¡ç†ç³»çµ± | â­ï¸ | æ”¹ç”¨ OAuth |
| A.10.1.1 | åŠ å¯†æ§åˆ¶æ”¿ç­– | âœ… | bcrypt, HTTPS |
| A.12.2.1 | æƒ¡æ„ç¨‹å¼ç¢¼æ§åˆ¶ | âœ… | è¼¸å…¥é©—è­‰ã€CSP |
| A.12.4.1 | äº‹ä»¶è¨˜éŒ„ | âœ… | audit_logs + pino |
| A.14.2.1 | å®‰å…¨é–‹ç™¼æ”¿ç­– | âœ… | åƒæ•¸åŒ–æŸ¥è©¢ã€XSS é˜²è­· |
| A.14.2.5 | å®‰å…¨ç³»çµ±å·¥ç¨‹åŸå‰‡ | âœ… | RLSã€æœ€å°æ¬Šé™åŸå‰‡ |

### ISO 27034 æ‡‰ç”¨å®‰å…¨æª¢æŸ¥

| é …ç›® | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| è¼¸å…¥é©—è­‰ | âœ… | URLã€çŸ­ä»£ç¢¼ã€å¯†ç¢¼éƒ½æœ‰é©—è­‰ |
| è¼¸å‡ºç·¨ç¢¼ | âœ… | HTML/JS è½‰ç¾© |
| èº«ä»½é©—è­‰ | âœ… | JWT Token |
| æˆæ¬Šæ§åˆ¶ | âœ… | RLS è¡Œç´šå®‰å…¨ |
| éŒ¯èª¤è™•ç† | âœ… | Promise éŒ¯èª¤è™•ç†å·²å®Œæˆ |
| æ—¥èªŒè¨˜éŒ„ | âœ… | å¯©è¨ˆæ—¥èªŒ + æ‡‰ç”¨æ—¥èªŒ |
| è³‡æ–™ä¿è­· | âœ… | æ•æ„Ÿè³‡æ–™åŠ å¯†/é›œæ¹Š |

---

## âš ï¸ ç¶­è­·æ³¨æ„äº‹é …

### CDN ç‰ˆæœ¬æ›´æ–°æ™‚éœ€é‡æ–°ç”Ÿæˆ SRI Hash

å¦‚æœéœ€è¦æ›´æ–° CDN è³‡æºç‰ˆæœ¬ï¼Œå¿…é ˆåŒæ™‚æ›´æ–° SRI hashï¼Œå¦å‰‡ç€è¦½å™¨æœƒæ‹’çµ•è¼‰å…¥ã€‚

**æ›´æ–°æ­¥é©Ÿ**ï¼š
```bash
# 1. ç”Ÿæˆæ–°ç‰ˆæœ¬çš„ SRI hash
curl -s "https://unpkg.com/qr-code-styling@æ–°ç‰ˆæœ¬/lib/qr-code-styling.js" | \
  openssl dgst -sha384 -binary | openssl base64 -A

# 2. æ›´æ–° HTML æª”æ¡ˆä¸­çš„ integrity å±¬æ€§
# 3. æ›´æ–°æœ¬æ–‡ä»¶ä¸­çš„ hash è¨˜éŒ„
```

**éœ€è¦æ›´æ–°çš„æª”æ¡ˆæ¸…å–®**ï¼š
- `public/index.html`
- `public/edit.html`
- `public/links.html`
- `public/analytics.html`

---

## ğŸŸ¢ å·²å®Œæˆçš„å®‰å…¨æªæ–½

### âœ… XSS é˜²è­·
**æª”æ¡ˆ**: `src/utils/html-templates.ts:7-31`
- `escapeHtml()` - HTML ç‰¹æ®Šå­—ç¬¦è½‰ç¾©
- `escapeJs()` - JavaScript å­—ä¸²è½‰ç¾©
- æ‰€æœ‰ä½¿ç”¨è€…è¼¸å…¥éƒ½æœ‰é©ç•¶è½‰ç¾©

### âœ… SQL Injection é˜²è­·
- ä½¿ç”¨ Supabase åƒæ•¸åŒ–æŸ¥è©¢
- æ²’æœ‰ç›´æ¥æ‹¼æ¥ SQL å­—ä¸²

### âœ… Rate Limiting
**æª”æ¡ˆ**: `src/index.ts:30-48`, `src/routes/urls.ts`
- å…¨åŸŸ: 100 æ¬¡/åˆ†é˜
- ç™»å…¥: 5 æ¬¡/åˆ†é˜
- è¨»å†Š: 3 æ¬¡/åˆ†é˜
- å¯†ç¢¼é©—è­‰: 5 æ¬¡/åˆ†é˜

### âœ… å¯†ç¢¼ Hash
**æª”æ¡ˆ**: `src/routes/urls.ts:277`
- ä½¿ç”¨ bcryptï¼ˆsaltRounds: 10ï¼‰
- å¯†ç¢¼ä¸ä»¥æ˜æ–‡å„²å­˜

### âœ… Row Level Security (RLS)
- Supabase RLS å·²å•Ÿç”¨
- ä½¿ç”¨é›™å®¢æˆ¶ç«¯æ¨¡å¼ï¼ˆService Client / User Clientï¼‰
- ä½¿ç”¨è€…åªèƒ½å­˜å–è‡ªå·±çš„è³‡æ–™

### âœ… çŸ­ä»£ç¢¼æ ¼å¼é©—è­‰
**æª”æ¡ˆ**: `src/utils/shortcode.ts:22-26`
- æ­£å‰‡é©—è­‰: `/^[a-zA-Z0-9]{4,20}$/`
- åªå…è¨±å­—æ¯å’Œæ•¸å­—

### âœ… å¾Œç«¯çŸ­ä»£ç¢¼ä½¿ç”¨å®‰å…¨éš¨æ©Ÿæ•¸
**æª”æ¡ˆ**: `src/utils/shortcode.ts:10`
- ä½¿ç”¨ `crypto.randomBytes()`

### âœ… è³‡æ–™åº«å¯©è¨ˆæ—¥èªŒ
**ç¢ºèªæ—¥æœŸ**: 2024-12-05
**ä½ç½®**: Supabase PostgreSQL `audit_logs` è¡¨
**è¡¨çµæ§‹**:
| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | ä¸»éµ |
| user_id | UUID | æ“ä½œä½¿ç”¨è€… ID |
| user_email | TEXT | æ“ä½œä½¿ç”¨è€… Email |
| action | TEXT | æ“ä½œé¡å‹ï¼ˆcreate_url, update_url, delete_url ç­‰ï¼‰|
| resource_type | TEXT | è³‡æºé¡å‹ï¼ˆurlï¼‰|
| resource_id | UUID | è³‡æº ID |
| old_values | JSONB | è®Šæ›´å‰çš„å€¼ |
| new_values | JSONB | è®Šæ›´å¾Œçš„å€¼ |
| created_at | TIMESTAMPTZ | å»ºç«‹æ™‚é–“ |

**å·²å¯¦ä½œçš„è§¸ç™¼å™¨**:
- `url_audit_trigger` - ç›£æ§ `urls` è¡¨çš„ INSERTã€UPDATEã€DELETE æ“ä½œ

**å·²è¨˜éŒ„çš„æ“ä½œé¡å‹**:
- âœ… `create_url` - å»ºç«‹çŸ­ç¶²å€
- âœ… `update_url` - æ›´æ–°çŸ­ç¶²å€
- âœ… `update_qrcode` - æ›´æ–° QR Code
- âœ… `delete_url` - åˆªé™¤çŸ­ç¶²å€

**å¾…è£œå……çš„æ—¥èªŒ**:
- [x] ç™»å…¥å¤±æ•—è¨˜éŒ„ â­ï¸ï¼ˆæ”¹ç”¨ OAuthï¼Œç”±æä¾›è€…è™•ç†ï¼‰
- [x] å¯†ç¢¼é©—è­‰å¤±æ•—è¨˜éŒ„ â­ï¸ï¼ˆæ”¹ç”¨ OAuthï¼Œç”±æä¾›è€…è™•ç†ï¼‰
- [ ] æ•æ„Ÿæ“ä½œè¨˜éŒ„ï¼ˆä¿®æ”¹å¯†ç¢¼ä¿è­·è¨­å®šï¼‰- å¯é¸

---

## éšæ®µ 1ï¼šåŸºç¤å®‰å…¨æª¢æŸ¥æ¸…å–®

### OWASP Top 10 é˜²è­·ç‹€æ…‹

| é¡åˆ¥ | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| A01 - å­˜å–æ§åˆ¶å¤±æ•ˆ | âœ… | RLS å·²å•Ÿç”¨ï¼Œé›™å®¢æˆ¶ç«¯æ¨¡å¼æ­£ç¢ºå¯¦ä½œ |
| A02 - åŠ å¯†æ©Ÿåˆ¶å¤±æ•ˆ | âœ… | bcrypt hash + HTTPS + HSTS |
| A03 - æ³¨å…¥æ”»æ“Š | âœ… | Supabase åƒæ•¸åŒ–æŸ¥è©¢ + XSS é˜²è­· |
| A04 - ä¸å®‰å…¨è¨­è¨ˆ | âœ… | URL é©—è­‰å·²å®Œæˆï¼ŒRate Limiting å·²å¯¦ä½œ |
| A05 - å®‰å…¨è¨­å®šéŒ¯èª¤ | âœ… | CORS ç™½åå–®ã€Helmet å®‰å…¨ Headers |
| A06 - æ˜“å—æ”»æ“Šå…ƒä»¶ | âœ… | npm audit ç„¡æ¼æ´ |
| A07 - èº«ä»½é©—è­‰å¤±æ•— | â­ï¸ | æ”¹ç”¨ OAuthï¼ˆç”±æä¾›è€…è™•ç†ï¼‰|
| A08 - è»Ÿé«”å®Œæ•´æ€§å¤±æ•— | âœ… | SRI å·²åŠ å…¥ |
| A09 - æ—¥èªŒç›£æ§å¤±æ•— | âœ… | å¯©è¨ˆæ—¥èªŒ + Promise éŒ¯èª¤è™•ç†å·²å®Œæˆ |
| A10 - SSRF | âœ… | URL é©—è­‰å®Œæ•´å¯¦ä½œ |

---

## å¿«é€Ÿä¿®å¾©æŒ‡ä»¤

```bash
# 1. ä¿®å¾© npm æ¼æ´
npm audit fix

# 2. å®‰è£å®‰å…¨å¥—ä»¶
npm install @fastify/helmet

# 3. ä¿®å¾© .env æ¬Šé™
chmod 600 .env

# 4. å»ºç«‹ .gitignore
cat > .gitignore << 'EOF'
.env
.env.local
.env.*.local
node_modules/
dist/
*.log
logs/
public/qrcodes/*.png
.DS_Store
EOF
```

---

## å¯¦æ–½å„ªå…ˆé †åº

```
ç«‹å³ï¼ˆæœ¬é€±ï¼‰:
â”œâ”€â”€ ğŸ”´ ä¿®å¾© npm æ¼æ´
â”œâ”€â”€ ğŸ”´ ä¿®å¾© CORS è¨­å®š
â”œâ”€â”€ ğŸ”´ åŠ å…¥å®‰å…¨ Headers
â”œâ”€â”€ ğŸ”´ ä¿®å¾© .env æ¬Šé™
â””â”€â”€ ğŸ”´ å»ºç«‹ .gitignore

çŸ­æœŸï¼ˆå…©é€±å…§ï¼‰:
â”œâ”€â”€ ğŸ”´ åŠ å…¥ URL æ ¼å¼é©—è­‰ âœ…
â”œâ”€â”€ ğŸŸ¡ ä¿®å¾©å‰ç«¯éš¨æ©Ÿæ•¸ç”Ÿæˆ âœ…
â”œâ”€â”€ ğŸŸ¡ åŠ å¼·å¯†ç¢¼è¤‡é›œåº¦é©—è­‰ â­ï¸ (æ”¹ç”¨ OAuth)
â””â”€â”€ ğŸŸ¡ è¨­å®š Redis èªè­‰ âœ…

ä¸­æœŸï¼ˆä¸€å€‹æœˆå…§ï¼‰:
â”œâ”€â”€ ğŸŸ¡ åŠ å…¥å¸³è™Ÿé–å®šæ©Ÿåˆ¶ â­ï¸ (æ”¹ç”¨ OAuth)
â”œâ”€â”€ ğŸŸ¡ è£œå……ç™»å…¥/å¯†ç¢¼é©—è­‰å¤±æ•—æ—¥èªŒ â­ï¸ (æ”¹ç”¨ OAuth)
â””â”€â”€ ğŸŸ¡ SRI å®Œæ•´æ€§æª¢æŸ¥ âœ…
```

---

## ğŸš€ å£“åŠ›æ¸¬è©¦èˆ‡æ€§èƒ½åŸºæº–

### æ¸¬è©¦å·¥å…·

**å®‰è£æ—¥æœŸ**: 2025-12-06

| å·¥å…· | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| autocannon | ^8.0.0 | HTTP å£“åŠ›æ¸¬è©¦ |
| clinic.js | ^13.0.0 | Node.js æ€§èƒ½åˆ†æ |

### æ¸¬è©¦è…³æœ¬

| è…³æœ¬ | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| è² è¼‰æ¸¬è©¦ | `scripts/load-test.ts` | éšæ®µå¼æŒçºŒå£“åŠ›æ¸¬è©¦ |
| è„ˆè¡æ¸¬è©¦ | `scripts/pulse-test.ts` | æ¨¡æ“¬çœŸå¯¦æµé‡è„ˆè¡ |

**åŸ·è¡Œæ–¹å¼**ï¼š
```bash
# è² è¼‰æ¸¬è©¦ï¼ˆé€£çºŒ 30 ç§’/éšæ®µï¼‰
npx tsx scripts/load-test.ts https://url.tzuchi.org shortCode

# è„ˆè¡æ¸¬è©¦ï¼ˆæ¯ 5 ç§’ä¸€æ³¢ï¼Œæ”¯æ´å¤šç¶²å€æ¯”è¼ƒï¼‰
npx tsx scripts/pulse-test.ts https://url.tzuchi.org code1,code2
```

### SLI/SLO å®šç¾©

åŸºæ–¼ **ISO/IEC 25010:2011** æ€§èƒ½æ•ˆç‡æ¨™æº–ï¼š

| æŒ‡æ¨™ | ç›®æ¨™å€¼ | èªªæ˜ |
|------|--------|------|
| P99 å»¶é² | < 500ms | 99% è«‹æ±‚åœ¨ 500ms å…§å®Œæˆ |
| P95 å»¶é² | < 200ms | 95% è«‹æ±‚åœ¨ 200ms å…§å®Œæˆ |
| éŒ¯èª¤ç‡ | < 0.1% | éŒ¯èª¤è«‹æ±‚æ¯”ä¾‹ |
| æœ€ä½ RPS | > 1000 | æ¯ç§’è«‹æ±‚æ•¸ï¼ˆåœ¨åˆç†ç¡¬é«”ä¸‹ï¼‰|

### åŸºæº–æ¸¬è©¦çµæœ

**æ¸¬è©¦æ—¥æœŸ**: 2025-12-06
**æ¸¬è©¦ç›®æ¨™**: `https://url.tzuchi.org/s/yFVOO2`
**ä¼ºæœå™¨è¦æ ¼**: 2 CPU coresï¼ˆPM2 cluster modeï¼Œ2 instancesï¼‰

| éšæ®µ | ä¸¦ç™¼æ•¸ | ç¸½è«‹æ±‚ | å¹³å‡å»¶é² | P99 å»¶é² | RPS | éŒ¯èª¤ |
|------|--------|--------|----------|----------|-----|------|
| 1 | 10 | 22,445 | 19.89ms | 68ms | 748 | 0 |
| 2 | 50 | 93,214 | 21.49ms | 104ms | 3,107 | 0 |
| 3 | 100 | 53,579 | 55.53ms | 213ms | 1,786 | 0 |
| 4 | 200 | 129,165 | 48.46ms | 249ms | 4,305 | 0 |

**çµè«–**ï¼š
- âœ… P99 å»¶é²å…¨éƒ¨ < 500msï¼ˆç¬¦åˆ SLOï¼‰
- âœ… éŒ¯èª¤ç‡ 0%ï¼ˆç¬¦åˆ SLOï¼‰
- âš ï¸ é«˜ä¸¦ç™¼ï¼ˆ100+ï¼‰æ™‚ RPS ä¸‹é™ï¼Œå›  CPU é£½å’Œ
- ğŸ’¡ å»ºè­°ï¼šå‡ç´š CPU æˆ–åŠ å…¥ Nginx åå‘ä»£ç†å¿«å–

### Rate Limiting ç’°å¢ƒè®Šæ•¸æ§åˆ¶

ç‚ºäº†é€²è¡Œå£“åŠ›æ¸¬è©¦ï¼ŒRate Limiting æ”¯æ´ç’°å¢ƒè®Šæ•¸æ§åˆ¶ï¼š

| è®Šæ•¸ | é è¨­å€¼ | èªªæ˜ |
|------|--------|------|
| `RATE_LIMIT_ENABLED` | `true` | è¨­ç‚º `false` å®Œå…¨ç¦ç”¨ |
| `RATE_LIMIT_MAX` | `100` | æ¯æ™‚é–“çª—å£æœ€å¤§è«‹æ±‚æ•¸ |
| `RATE_LIMIT_WINDOW` | `1 minute` | æ™‚é–“çª—å£é•·åº¦ |

**å£“åŠ›æ¸¬è©¦æ™‚ç¦ç”¨ Rate Limiting**ï¼š
```bash
# æ–¹æ³• 1ï¼šç’°å¢ƒè®Šæ•¸
RATE_LIMIT_ENABLED=false npm start

# æ–¹æ³• 2ï¼šPM2 ecosystem.config.cjs
env: {
  RATE_LIMIT_ENABLED: 'false'
}
```

âš ï¸ **æ³¨æ„**ï¼šæ­£å¼ç’°å¢ƒå¿…é ˆå•Ÿç”¨ Rate Limiting

### æ€§èƒ½å„ªåŒ–å»ºè­°

| å„ªå…ˆç´š | å»ºè­° | é æœŸæ•ˆæœ |
|--------|------|----------|
| é«˜ | åŠ å…¥ Nginx åå‘ä»£ç† + HTTP å¿«å– | æ¸›å°‘ Node.js è² è¼‰ï¼Œæå‡ RPS |
| é«˜ | å‡ç´š CPU æ ¸å¿ƒæ•¸ | æ”¯æ´æ›´å¤š PM2 cluster instances |
| ä¸­ | å•Ÿç”¨ CDNï¼ˆå¦‚ Cloudflareï¼‰ | é‚Šç·£å¿«å–ï¼Œæ¸›å°‘ä¼ºæœå™¨å£“åŠ› |
| ä½ | Redis Cluster | åˆ†æ•£å¿«å–è² è¼‰ï¼ˆç›®å‰å–®æ©Ÿè¶³å¤ ï¼‰|

### å ±å‘Šå„²å­˜

æ¸¬è©¦å ±å‘Šè‡ªå‹•ä¿å­˜æ–¼ `reports/` ç›®éŒ„ï¼š
- `load-test-{timestamp}.json` - è² è¼‰æ¸¬è©¦çµæœ
- `pulse-test-{timestamp}.json` - è„ˆè¡æ¸¬è©¦çµæœ

---

## ç›¸é—œè³‡æº

- [OWASP Top 10](https://owasp.org/Top10/)
- [Fastify Security](https://fastify.dev/docs/latest/Guides/Recommendations/)
- [Supabase Security](https://supabase.com/docs/guides/platform/going-into-prod)
- [@fastify/helmet](https://github.com/fastify/fastify-helmet)
- [ISO/IEC 25010:2011](https://www.iso.org/standard/35733.html) - ç³»çµ±å“è³ªæ¨¡å‹
- [autocannon](https://github.com/mcollina/autocannon) - HTTP å£“åŠ›æ¸¬è©¦å·¥å…·

---

**æœ€å¾Œæ›´æ–°**: 2025-12-06
**ä¸‹æ¬¡å¯©æŸ¥**: æ€§èƒ½å„ªåŒ–å¯¦æ–½å¾Œï¼ˆNginx åå‘ä»£ç†ï¼‰
